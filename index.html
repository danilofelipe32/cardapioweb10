<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Black Burger - Cardápio Digital</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'slide-up': 'slideUp 0.5s ease-out',
                        'pulse-slow': 'pulseInterval 5s ease-in-out infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        pulseInterval: {
                             '0%, 100%': { transform: 'scale(1)', filter: 'brightness(1)' },
                             '10%': { transform: 'scale(1.02)', filter: 'brightness(1.1)' },
                             '20%': { transform: 'scale(1)' }
                        }
                    }
                }
            }
        }
    </script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- QR Code Generator Lib -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .dark ::-webkit-scrollbar-thumb {
            background: #555;
        }
        .dark ::-webkit-scrollbar-thumb:hover {
            background: #777;
        }
        
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        html {
            scroll-behavior: smooth;
        }
        
        input[type=range] {
            -webkit-appearance: none; 
            background: transparent; 
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
        }
        input[type=range]:focus {
            outline: none; 
        }
    </style>
</head>
<body class="text-neutral-900 transition-colors duration-300 dark:text-gray-100 font-sans selection:bg-red-500/30 selection:text-red-900 dark:selection:text-red-200 bg-transparent">

    <!-- Fundo com Vídeo e Fallback -->
    <div class="fixed inset-0 -z-50 w-full h-full overflow-hidden">
        <!-- Vídeo de Fundo (Loop) -->
        <video autoplay loop muted playsinline class="absolute inset-0 w-full h-full object-cover">
            <source src="https://i.imgur.com/Tvbxj6Z.mp4" type="video/mp4">
        </video>
        
        <!-- Overlay para legibilidade -->
        <div class="absolute inset-0 bg-gray-100/90 dark:bg-black/85 backdrop-blur-[2px] transition-colors duration-300"></div>
        
        <!-- Partículas Sutis -->
        <div class="absolute top-[-10%] left-[-10%] w-[500px] h-[500px] bg-orange-600/20 blur-[100px] rounded-full mix-blend-overlay"></div>
        <div class="absolute bottom-[-10%] right-[-10%] w-[600px] h-[600px] bg-red-900/20 blur-[120px] rounded-full mix-blend-overlay"></div>
    </div>

    <!-- App Container -->
    <div id="app" class="relative min-h-screen flex flex-col">
        
        <!-- Aviso de Mesa Identificada -->
        <div id="table-badge" class="hidden bg-green-600 text-white text-center py-1 text-xs font-bold uppercase tracking-widest sticky top-0 z-[60]">
            <i data-lucide="map-pin" class="inline w-3 h-3 mb-0.5 mr-1"></i> Mesa <span id="table-number-display"></span> Identificada
        </div>

        <!-- Header -->
        <header class="sticky top-0 z-50 w-full bg-white/80 dark:bg-black/70 backdrop-blur-xl border-b border-black/5 dark:border-white/5 transition-colors duration-300 shadow-sm transition-top duration-300" id="main-header">
            <div class="max-w-7xl mx-auto px-4 h-20 flex justify-between items-center">
                <div class="flex items-center gap-3 cursor-pointer group" onclick="closeDetails()">
                    <div class="bg-gradient-to-tr from-red-600 to-red-500 p-2.5 rounded-xl shadow-[0_0_20px_rgba(220,38,38,0.3)] group-hover:scale-105 transition-transform duration-300">
                        <i data-lucide="chef-hat" class="text-white w-5 h-5"></i>
                    </div>
                    <div class="flex flex-col -space-y-1">
                        <span class="text-xs font-bold text-neutral-400 dark:text-neutral-500 tracking-[0.2em] uppercase">The Original</span>
                        <h1 class="text-2xl font-black tracking-tighter text-neutral-900 dark:text-white">
                            BLACK<span class="text-red-600 dark:text-red-500">BURGER</span>
                        </h1>
                    </div>
                </div>

                <div class="flex items-center gap-2 md:gap-6">
                    <button onclick="toggleTheme()" class="p-2 rounded-full text-neutral-500 hover:bg-black/5 dark:hover:bg-white/10 transition-colors">
                        <i id="theme-icon" data-lucide="moon" class="w-5 h-5"></i>
                    </button>

                    <button onclick="toggleCart()" class="flex items-center gap-3 group relative p-2 md:p-0">
                        <span class="hidden md:block text-sm font-medium text-neutral-500 dark:text-neutral-400 group-hover:text-black dark:group-hover:text-white transition-colors">Seu Pedido</span>
                        <div class="relative bg-black/5 dark:bg-white/5 group-hover:bg-red-600 dark:group-hover:bg-red-600 group-hover:text-white text-neutral-900 dark:text-white p-2.5 md:p-3 rounded-2xl transition-all duration-300 border border-black/5 dark:border-white/5 group-hover:border-red-500 group-hover:shadow-[0_0_20px_rgba(220,38,38,0.4)]">
                            <i data-lucide="shopping-cart" class="w-5 h-5"></i>
                            <span id="cart-count" class="absolute -top-1.5 -right-1.5 bg-white text-red-600 text-[10px] font-black w-5 h-5 flex items-center justify-center rounded-full shadow-lg border border-red-100 hidden">0</span>
                        </div>
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content Area -->
        <main id="main-view" class="flex-1 relative z-10">
            
            <!-- Hero Title -->
            <section class="relative pt-12 pb-8 px-4 text-center overflow-hidden">
                <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[120%] h-full bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-white/30 via-transparent to-transparent dark:from-black/30 dark:to-transparent -z-10"></div>
                
                <h2 class="text-4xl md:text-8xl font-black mb-4 tracking-tighter leading-[0.9] text-neutral-900 dark:text-white animate-pulse-slow drop-shadow-sm">
                    SABOR QUE <br />
                    <span class="text-transparent bg-clip-text bg-gradient-to-b from-red-600 to-red-800 dark:from-red-500 dark:to-red-800">DOMINA</span>
                </h2>
                <p class="text-neutral-600 dark:text-neutral-300 max-w-xl mx-auto text-base md:text-xl font-light shadow-black/5">
                    Hambúrgueres artesanais feitos com paixão e ingredientes premium.
                </p>
            </section>

            <!-- Sticky Controls Section -->
            <section class="sticky top-20 z-40 bg-white/80 dark:bg-black/70 backdrop-blur-md border-y border-black/5 dark:border-white/5 shadow-sm transition-colors duration-300 py-4" id="controls-section">
                <div class="max-w-7xl mx-auto px-4 space-y-4">
                    
                    <!-- Search Bar -->
                    <div class="relative max-w-md mx-auto w-full transition-all duration-300" id="search-container">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i data-lucide="search" class="h-5 w-5 text-neutral-400"></i>
                        </div>
                        <input 
                            type="text" 
                            id="search-input"
                            placeholder="Toque para buscar e filtrar..." 
                            class="block w-full pl-10 pr-10 py-3 border border-black/5 dark:border-white/10 rounded-xl leading-5 bg-white/90 dark:bg-white/10 text-neutral-900 dark:text-white placeholder-neutral-500 focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-red-500 transition-all sm:text-sm shadow-sm backdrop-blur-sm"
                            oninput="handleSearch(this.value)"
                            onfocus="openSearchMode()"
                        >
                        <button onclick="closeSearchMode()" id="search-close-btn" class="absolute inset-y-0 right-0 pr-3 flex items-center hidden text-neutral-400 hover:text-red-500 transition-colors">
                            <i data-lucide="x" class="h-5 w-5"></i>
                        </button>
                    </div>

                    <!-- Collapsible Filters Wrapper -->
                    <div id="search-filters-wrapper" class="hidden space-y-4 animate-fade-in">
                        <div class="flex justify-start md:justify-center overflow-x-auto no-scrollbar pb-1 -mx-4 px-4 md:mx-0">
                            <div id="categories-container" class="inline-flex space-x-2"></div>
                        </div>
                        <div id="filters-container" class="flex flex-wrap justify-center gap-2 md:gap-3"></div>
                    </div>
                </div>
            </section>

            <!-- Best Sellers -->
            <section id="best-sellers-section" class="max-w-7xl mx-auto px-4 mt-8 mb-8 animate-slide-up scroll-mt-48">
                <div class="flex items-center gap-2 mb-6 text-red-600 dark:text-red-500">
                    <i data-lucide="flame" class="animate-pulse w-6 h-6 fill-current"></i>
                    <h3 class="text-xl font-black uppercase tracking-wider text-neutral-900 dark:text-white drop-shadow-sm">MAIS PEDIDOS</h3>
                </div>
                <div id="best-sellers-grid" class="flex overflow-x-auto gap-6 pb-4 no-scrollbar snap-x -mx-4 px-4 md:mx-0 md:px-0"></div>
            </section>

            <!-- Full Menu Grid -->
            <div id="full-menu-container" class="max-w-7xl mx-auto px-4 pb-16 pt-4">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center gap-2 text-neutral-500 dark:text-neutral-400">
                        <i data-lucide="chef-hat" class="w-5 h-5"></i>
                        <h3 id="menu-title" class="text-sm font-bold uppercase tracking-wider">CARDÁPIO COMPLETO</h3>
                    </div>
                </div>
                
                <div id="products-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
                <div id="empty-state" class="hidden text-center py-20">
                    <div class="inline-flex p-4 rounded-full bg-neutral-100 dark:bg-neutral-800 mb-4 text-neutral-400">
                        <i data-lucide="search-x" class="w-8 h-8"></i>
                    </div>
                    <p class="text-neutral-500 dark:text-neutral-400 text-lg font-medium">Nenhum item encontrado.</p>
                </div>
            </div>

            <!-- Footer -->
            <footer class="mt-auto border-t border-black/5 dark:border-white/5 bg-white/60 dark:bg-black/60 backdrop-blur-xl transition-colors duration-300">
                <div class="max-w-7xl mx-auto px-4 py-8">
                    <div class="flex flex-col md:flex-row items-center justify-between gap-6">
                        
                        <!-- Logo & Copyright -->
                        <div class="text-center md:text-left">
                            <div class="flex items-center justify-center md:justify-start gap-2 mb-1">
                                <i data-lucide="chef-hat" class="text-red-600 w-5 h-5"></i>
                                <span class="text-lg font-black text-neutral-900 dark:text-white tracking-tighter">
                                    BLACK<span class="text-red-600">BURGER</span>
                                </span>
                            </div>
                            <p class="text-neutral-500 text-xs">
                                &copy; 2024 Black Burger. Feito com <i data-lucide="heart" class="inline w-3 h-3 text-red-500 fill-current"></i>
                            </p>
                        </div>

                        <!-- Socials -->
                        <div class="flex items-center gap-4">
                            <a href="#" class="w-10 h-10 rounded-full bg-black/5 dark:bg-white/5 hover:bg-red-600 dark:hover:bg-red-600 hover:text-white dark:text-white flex items-center justify-center transition-all duration-300 transform hover:scale-110">
                                <i data-lucide="instagram" class="w-4 h-4"></i>
                            </a>
                            <a href="#" class="w-10 h-10 rounded-full bg-black/5 dark:bg-white/5 hover:bg-blue-600 dark:hover:bg-blue-600 hover:text-white dark:text-white flex items-center justify-center transition-all duration-300 transform hover:scale-110">
                                <i data-lucide="facebook" class="w-4 h-4"></i>
                            </a>
                            <a href="#" class="w-10 h-10 rounded-full bg-black/5 dark:bg-white/5 hover:bg-black dark:hover:bg-white hover:text-white dark:hover:text-black dark:text-white flex items-center justify-center transition-all duration-300 transform hover:scale-110">
                                <i data-lucide="twitter" class="w-4 h-4"></i>
                            </a>
                        </div>

                        <!-- Admin Link -->
                        <button onclick="toggleLoginModal()" class="text-xs font-bold text-neutral-400 hover:text-red-600 transition-colors uppercase tracking-widest flex items-center gap-2">
                            <i data-lucide="lock" class="w-3 h-3"></i> Admin
                        </button>
                    </div>
                </div>
            </footer>
        </main>

        <!-- Product Details View -->
        <div id="details-view" class="hidden flex-1 animate-fade-in relative z-20">
            <div class="max-w-7xl mx-auto px-4 py-8">
                <button onclick="closeDetails()" class="group flex items-center gap-2 text-neutral-500 hover:text-black dark:hover:text-white mb-8 transition-colors font-medium text-sm">
                    <div class="p-2 rounded-full bg-black/5 dark:bg-white/10 group-hover:bg-black/10 dark:group-hover:bg-white/20 transition-colors">
                        <i data-lucide="arrow-left" class="w-4 h-4"></i>
                    </div>
                    VOLTAR AO MENU
                </button>
                <div id="details-content" class="grid grid-cols-1 lg:grid-cols-12 gap-12 items-start"></div>
            </div>
        </div>

        <!-- Login Modal (Overlay) -->
        <div id="login-modal" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/80 backdrop-blur-sm hidden animate-fade-in p-4">
            <div class="bg-white dark:bg-[#111] w-full max-w-md p-8 rounded-3xl shadow-2xl border border-white/10 relative">
                <button onclick="toggleLoginModal()" class="absolute top-4 right-4 text-neutral-400 hover:text-white transition-colors">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
                
                <div class="text-center mb-8">
                    <i data-lucide="shield-check" class="w-12 h-12 text-red-600 mx-auto mb-4"></i>
                    <h2 class="text-2xl font-black text-neutral-900 dark:text-white">ACESSO RESTRITO</h2>
                    <p class="text-neutral-500 text-sm">Área administrativa do Black Burger</p>
                </div>

                <form onsubmit="handleLogin(event)" class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-neutral-500 uppercase tracking-wider mb-2">Usuário</label>
                        <input type="text" id="login-user" class="w-full bg-gray-50 dark:bg-black/50 border border-black/10 dark:border-white/10 p-4 rounded-xl text-neutral-900 dark:text-white focus:border-red-500 outline-none transition-colors" placeholder="admin">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-neutral-500 uppercase tracking-wider mb-2">Senha</label>
                        <input type="password" id="login-pass" class="w-full bg-gray-50 dark:bg-black/50 border border-black/10 dark:border-white/10 p-4 rounded-xl text-neutral-900 dark:text-white focus:border-red-500 outline-none transition-colors" placeholder="••••">
                    </div>
                    <button type="submit" class="w-full bg-red-600 hover:bg-red-500 text-white font-bold py-4 rounded-xl shadow-lg shadow-red-600/20 transition-all flex items-center justify-center gap-2">
                        ENTRAR <i data-lucide="arrow-right" class="w-5 h-5"></i>
                    </button>
                </form>
            </div>
        </div>

        <!-- Admin Dashboard -->
        <div id="admin-dashboard" class="fixed inset-0 z-50 bg-gray-50/95 dark:bg-black/95 backdrop-blur-sm overflow-y-auto hidden">
            <!-- Admin Header -->
            <div class="sticky top-0 z-50 bg-white/90 dark:bg-black/90 backdrop-blur-xl border-b border-black/5 dark:border-white/5 shadow-sm">
                <div class="max-w-7xl mx-auto px-4 h-20 flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <div class="bg-red-600 p-2 rounded-lg">
                            <i data-lucide="layout-dashboard" class="text-white w-5 h-5"></i>
                        </div>
                        <div>
                            <span class="text-xs font-bold text-red-600 uppercase tracking-wider">Modo Admin</span>
                            <h1 class="text-xl font-black text-neutral-900 dark:text-white">Gerenciar</h1>
                        </div>
                    </div>
                    <button onclick="toggleAdminDashboard()" class="px-4 py-2 rounded-xl border border-black/10 dark:border-white/10 text-neutral-600 dark:text-neutral-400 hover:bg-black/5 dark:hover:bg-white/5 font-bold text-sm transition-colors flex items-center gap-2">
                        <i data-lucide="log-out" class="w-4 h-4"></i> SAIR
                    </button>
                </div>
                <!-- Admin Tabs -->
                <div class="max-w-7xl mx-auto px-4 border-t border-black/5 dark:border-white/5">
                    <div class="flex gap-6 overflow-x-auto no-scrollbar">
                        <button onclick="switchAdminView('products')" id="tab-products" class="py-3 text-sm font-bold border-b-2 border-red-600 text-red-600 dark:text-white transition-colors whitespace-nowrap">
                            CARDÁPIO
                        </button>
                        <button onclick="switchAdminView('orders')" id="tab-orders" class="py-3 text-sm font-bold border-b-2 border-transparent text-neutral-500 hover:text-black dark:hover:text-white transition-colors whitespace-nowrap">
                            PEDIDOS
                        </button>
                        <button onclick="switchAdminView('qr')" id="tab-qr" class="py-3 text-sm font-bold border-b-2 border-transparent text-neutral-500 hover:text-black dark:hover:text-white transition-colors whitespace-nowrap">
                            QR CODES
                        </button>
                    </div>
                </div>
            </div>

            <div class="max-w-7xl mx-auto px-4 py-8 pb-32">
                
                <!-- VIEW: PRODUTOS -->
                <div id="admin-view-products">
                    <!-- Add/Edit Form -->
                    <div class="bg-white dark:bg-[#111] border border-black/5 dark:border-white/5 rounded-3xl p-6 md:p-8 shadow-xl mb-12">
                        <h3 class="text-lg font-bold text-neutral-900 dark:text-white mb-6 flex items-center gap-2">
                            <i data-lucide="plus-circle" class="text-red-600 w-5 h-5"></i>
                            <span id="form-title">Adicionar Novo Item</span>
                        </h3>
                        
                        <form onsubmit="handleSaveProduct(event)" class="space-y-6">
                            <input type="hidden" id="edit-id">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="space-y-2">
                                    <label class="text-xs font-bold text-neutral-500 uppercase">Nome do Produto</label>
                                    <input id="admin-name" class="w-full bg-gray-50 dark:bg-black/50 border border-black/10 dark:border-white/10 p-3 rounded-xl text-neutral-900 dark:text-white focus:border-red-500 outline-none" required />
                                </div>
                                <div class="space-y-2">
                                    <label class="text-xs font-bold text-neutral-500 uppercase">Preço (R$)</label>
                                    <input id="admin-price" type="number" step="0.10" class="w-full bg-gray-50 dark:bg-black/50 border border-black/10 dark:border-white/10 p-3 rounded-xl text-neutral-900 dark:text-white focus:border-red-500 outline-none" required />
                                </div>
                            </div>
                            
                            <div class="space-y-2">
                                <label class="text-xs font-bold text-neutral-500 uppercase">URL da Imagem</label>
                                <input id="admin-image" class="w-full bg-gray-50 dark:bg-black/50 border border-black/10 dark:border-white/10 p-3 rounded-xl text-neutral-900 dark:text-white focus:border-red-500 outline-none" placeholder="https://..." />
                            </div>

                            <div class="space-y-2">
                                <label class="text-xs font-bold text-neutral-500 uppercase">Descrição</label>
                                <textarea id="admin-desc" class="w-full bg-gray-50 dark:bg-black/50 border border-black/10 dark:border-white/10 p-3 rounded-xl text-neutral-900 dark:text-white focus:border-red-500 outline-none h-24 resize-none"></textarea>
                            </div>

                            <!-- Checkboxes para Tags -->
                            <div class="flex flex-wrap gap-4 py-2">
                                <label class="flex items-center gap-2 cursor-pointer bg-gray-50 dark:bg-white/5 px-3 py-2 rounded-lg border border-black/5 dark:border-white/5 hover:border-red-500/50 transition-colors">
                                    <input type="checkbox" id="admin-tag-spicy" class="w-4 h-4 accent-red-600 rounded cursor-pointer">
                                    <span class="text-sm font-bold text-neutral-700 dark:text-neutral-300 flex items-center gap-1"><i data-lucide="flame" class="w-3 h-3"></i> Picante</span>
                                </label>
                                <label class="flex items-center gap-2 cursor-pointer bg-gray-50 dark:bg-white/5 px-3 py-2 rounded-lg border border-black/5 dark:border-white/5 hover:border-green-500/50 transition-colors">
                                    <input type="checkbox" id="admin-tag-vegan" class="w-4 h-4 accent-green-600 rounded cursor-pointer">
                                    <span class="text-sm font-bold text-neutral-700 dark:text-neutral-300 flex items-center gap-1"><i data-lucide="leaf" class="w-3 h-3"></i> Vegano</span>
                                </label>
                                <label class="flex items-center gap-2 cursor-pointer bg-gray-50 dark:bg-white/5 px-3 py-2 rounded-lg border border-black/5 dark:border-white/5 hover:border-blue-500/50 transition-colors">
                                    <input type="checkbox" id="admin-tag-gluten_free" class="w-4 h-4 accent-blue-500 rounded cursor-pointer">
                                    <span class="text-sm font-bold text-neutral-700 dark:text-neutral-300 flex items-center gap-1"><i data-lucide="wheat-off" class="w-3 h-3"></i> Sem Glúten</span>
                                </label>
                            </div>

                            <div class="flex flex-col md:flex-row gap-4 items-end">
                                <div class="flex-1 space-y-2 w-full">
                                    <label class="text-xs font-bold text-neutral-500 uppercase">Categoria</label>
                                    <select id="admin-cat" class="w-full bg-gray-50 dark:bg-black/50 border border-black/10 dark:border-white/10 p-3 rounded-xl text-neutral-900 dark:text-white focus:border-red-500 outline-none cursor-pointer">
                                        <option>Sanduíches</option><option>Bebidas</option><option>Acompanhamentos</option>
                                    </select>
                                </div>
                                <button type="submit" id="save-btn" class="w-full md:w-auto bg-green-600 hover:bg-green-500 text-white font-bold py-3 px-8 rounded-xl flex items-center justify-center gap-2 transition-all shadow-lg shadow-green-600/20">
                                    <i data-lucide="save" class="w-4 h-4"></i> SALVAR PRODUTO
                                </button>
                                <button type="button" onclick="resetForm()" class="w-full md:w-auto bg-gray-200 dark:bg-white/10 text-neutral-600 dark:text-white font-bold py-3 px-6 rounded-xl transition-all hover:bg-gray-300 dark:hover:bg-white/20">
                                    LIMPAR
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Products List Table -->
                    <div class="bg-white dark:bg-[#111] border border-black/5 dark:border-white/5 rounded-3xl overflow-hidden shadow-xl">
                        <div class="p-6 border-b border-black/5 dark:border-white/5 flex justify-between items-center">
                            <h3 class="text-lg font-bold text-neutral-900 dark:text-white">Itens Cadastrados</h3>
                            <span class="text-xs font-bold bg-neutral-100 dark:bg-white/10 px-3 py-1 rounded-full text-neutral-500" id="total-items-badge">0 itens</span>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead class="bg-gray-50 dark:bg-black/20 text-xs uppercase text-neutral-500">
                                    <tr>
                                        <th class="p-4 pl-6">Produto</th>
                                        <th class="p-4">Categoria</th>
                                        <th class="p-4">Preço</th>
                                        <th class="p-4 text-right pr-6">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="admin-products-list" class="divide-y divide-black/5 dark:divide-white/5 text-sm">
                                    <!-- JS Injected -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- VIEW: DASHBOARD DE PEDIDOS -->
                <div id="admin-view-orders" class="hidden animate-fade-in space-y-8">
                    
                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                        <!-- Receita -->
                        <div class="bg-white dark:bg-[#111] p-6 rounded-2xl shadow-lg border border-black/5 dark:border-white/5 flex items-center justify-between group hover:-translate-y-1 transition-transform">
                            <div>
                                <p class="text-sm font-medium text-neutral-500 dark:text-neutral-400 mb-1">Receita Total</p>
                                <h4 class="text-2xl font-black text-neutral-900 dark:text-white" id="dash-total-revenue">R$ 0,00</h4>
                            </div>
                            <div class="w-12 h-12 rounded-full bg-green-50 dark:bg-green-900/20 text-green-600 dark:text-green-400 flex items-center justify-center group-hover:scale-110 transition-transform">
                                <i data-lucide="dollar-sign" class="w-6 h-6"></i>
                            </div>
                        </div>

                        <!-- Pedidos -->
                        <div class="bg-white dark:bg-[#111] p-6 rounded-2xl shadow-lg border border-black/5 dark:border-white/5 flex items-center justify-between group hover:-translate-y-1 transition-transform">
                            <div>
                                <p class="text-sm font-medium text-neutral-500 dark:text-neutral-400 mb-1">Total Pedidos</p>
                                <h4 class="text-2xl font-black text-neutral-900 dark:text-white" id="dash-total-count">0</h4>
                            </div>
                            <div class="w-12 h-12 rounded-full bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400 flex items-center justify-center group-hover:scale-110 transition-transform">
                                <i data-lucide="shopping-bag" class="w-6 h-6"></i>
                            </div>
                        </div>

                        <!-- Ticket Médio -->
                        <div class="bg-white dark:bg-[#111] p-6 rounded-2xl shadow-lg border border-black/5 dark:border-white/5 flex items-center justify-between group hover:-translate-y-1 transition-transform">
                            <div>
                                <p class="text-sm font-medium text-neutral-500 dark:text-neutral-400 mb-1">Ticket Médio</p>
                                <h4 class="text-2xl font-black text-neutral-900 dark:text-white" id="dash-avg-ticket">R$ 0,00</h4>
                            </div>
                            <div class="w-12 h-12 rounded-full bg-yellow-50 dark:bg-yellow-900/20 text-yellow-600 dark:text-yellow-400 flex items-center justify-center group-hover:scale-110 transition-transform">
                                <i data-lucide="trending-up" class="w-6 h-6"></i>
                            </div>
                        </div>

                        <!-- Conversão -->
                        <div class="bg-white dark:bg-[#111] p-6 rounded-2xl shadow-lg border border-black/5 dark:border-white/5 flex items-center justify-between group hover:-translate-y-1 transition-transform">
                            <div>
                                <p class="text-sm font-medium text-neutral-500 dark:text-neutral-400 mb-1">Entregues</p>
                                <h4 class="text-2xl font-black text-neutral-900 dark:text-white" id="dash-conversion">0%</h4>
                            </div>
                            <div class="w-12 h-12 rounded-full bg-purple-50 dark:bg-purple-900/20 text-purple-600 dark:text-purple-400 flex items-center justify-center group-hover:scale-110 transition-transform">
                                <i data-lucide="check-circle-2" class="w-6 h-6"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Orders Table Container -->
                    <div class="bg-white dark:bg-[#111] rounded-3xl border border-black/5 dark:border-white/5 shadow-xl overflow-hidden">
                        
                        <!-- Toolbar -->
                        <div class="p-6 border-b border-black/5 dark:border-white/5 flex flex-col lg:flex-row gap-4 justify-between items-end lg:items-center bg-gray-50/50 dark:bg-white/[0.02]">
                            <div>
                                <h3 class="text-lg font-bold text-neutral-900 dark:text-white">Últimos Pedidos</h3>
                                <p class="text-sm text-neutral-500">Gerencie o status e visualize detalhes</p>
                            </div>
                            
                            <div class="flex flex-wrap gap-3 w-full lg:w-auto">
                                <!-- Date Filter -->
                                <div class="flex items-center bg-white dark:bg-black border border-black/10 dark:border-white/10 rounded-xl px-3 py-2 shadow-sm">
                                    <i data-lucide="calendar" class="w-4 h-4 text-neutral-400 mr-2"></i>
                                    <input type="date" id="order-filter-start" onchange="handleOrderFilter()" class="bg-transparent text-sm font-medium text-neutral-900 dark:text-white focus:outline-none w-28 sm:w-auto">
                                    <span class="text-neutral-400 mx-2">-</span>
                                    <input type="date" id="order-filter-end" onchange="handleOrderFilter()" class="bg-transparent text-sm font-medium text-neutral-900 dark:text-white focus:outline-none w-28 sm:w-auto">
                                </div>

                                <!-- Status Filter -->
                                <div class="relative min-w-[140px]">
                                    <select id="order-filter-status" onchange="handleOrderFilter()" class="w-full appearance-none bg-white dark:bg-black border border-black/10 dark:border-white/10 rounded-xl px-4 py-2.5 text-sm font-bold text-neutral-700 dark:text-neutral-200 focus:outline-none focus:ring-2 focus:ring-red-500/20 shadow-sm cursor-pointer">
                                        <option value="all">Todos Status</option>
                                        <option value="Pendente">Pendentes</option>
                                        <option value="Em Preparo">Em Preparo</option>
                                        <option value="Entregue">Entregues</option>
                                        <option value="Cancelado">Cancelados</option>
                                    </select>
                                    <i data-lucide="chevron-down" class="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-neutral-400 pointer-events-none"></i>
                                </div>
                            </div>
                        </div>

                        <!-- Table -->
                        <div class="overflow-x-auto">
                            <table class="w-full text-left border-collapse">
                                <thead class="bg-gray-50/80 dark:bg-white/[0.02] border-b border-black/5 dark:border-white/5 text-xs font-bold text-neutral-500 uppercase tracking-wider">
                                    <tr>
                                        <th class="p-5 pl-6">ID Pedido</th>
                                        <th class="p-5">Data & Hora</th>
                                        <th class="p-5 w-1/3">Resumo</th>
                                        <th class="p-5">Total</th>
                                        <th class="p-5">Status</th>
                                        <th class="p-5 text-right pr-6">Ação</th>
                                    </tr>
                                </thead>
                                <tbody id="admin-orders-list" class="divide-y divide-black/5 dark:divide-white/5 text-sm font-medium">
                                    <!-- JS Injected -->
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Empty State -->
                        <div id="no-orders-msg" class="hidden flex flex-col items-center justify-center p-16 text-neutral-400">
                            <div class="w-16 h-16 bg-neutral-100 dark:bg-white/5 rounded-full flex items-center justify-center mb-4">
                                <i data-lucide="clipboard-x" class="w-8 h-8 opacity-50"></i>
                            </div>
                            <p class="text-base font-medium">Nenhum pedido encontrado.</p>
                            <p class="text-sm opacity-60">Tente ajustar os filtros acima.</p>
                        </div>
                    </div>
                </div>

                <!-- NEW VIEW: QR CODES GENERATOR -->
                <div id="admin-view-qr" class="hidden animate-fade-in">
                    <div class="bg-white dark:bg-[#111] border border-black/5 dark:border-white/5 rounded-3xl p-8 shadow-xl max-w-2xl mx-auto text-center">
                        <div class="mb-8">
                            <div class="inline-flex p-4 rounded-full bg-neutral-100 dark:bg-white/5 mb-4 text-neutral-900 dark:text-white">
                                <i data-lucide="qr-code" class="w-8 h-8"></i>
                            </div>
                            <h3 class="text-2xl font-black text-neutral-900 dark:text-white mb-2">Gerador de QR Code de Mesa</h3>
                            <p class="text-neutral-500">Crie QR Codes únicos para colar nas mesas. Quando o cliente escanear, o pedido virá identificado.</p>
                        </div>

                        <div class="space-y-6">
                            <div class="flex flex-col items-start text-left max-w-sm mx-auto">
                                <label class="text-xs font-bold text-neutral-500 uppercase tracking-wider mb-2">Número da Mesa</label>
                                <div class="flex w-full gap-2">
                                    <input type="number" id="qr-table-num" class="flex-1 bg-gray-50 dark:bg-black/50 border border-black/10 dark:border-white/10 p-4 rounded-xl text-neutral-900 dark:text-white focus:border-red-500 outline-none transition-colors text-center text-lg font-bold" placeholder="10">
                                    <button onclick="generateQRCode()" class="bg-red-600 hover:bg-red-500 text-white font-bold px-6 rounded-xl transition-colors">
                                        GERAR
                                    </button>
                                </div>
                            </div>

                            <div id="qr-result-area" class="hidden flex flex-col items-center animate-fade-in pt-8 border-t border-black/5 dark:border-white/5 mt-8">
                                <div class="bg-white p-4 rounded-2xl shadow-lg mb-4">
                                    <div id="qrcode-container"></div>
                                </div>
                                <p class="font-bold text-lg text-neutral-900 dark:text-white mb-4">Mesa <span id="qr-display-num"></span></p>
                                <button onclick="printQRCode()" class="text-sm font-bold text-neutral-500 hover:text-black dark:hover:text-white flex items-center gap-2 transition-colors">
                                    <i data-lucide="printer" class="w-4 h-4"></i> Imprimir / Salvar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- Order Details Modal -->
        <div id="order-details-modal" class="fixed inset-0 z-[70] flex items-center justify-center bg-black/80 backdrop-blur-sm hidden animate-fade-in p-4">
            <div class="bg-white dark:bg-[#111] w-full max-w-lg rounded-3xl shadow-2xl border border-white/10 flex flex-col max-h-[90vh]">
                <div class="p-6 border-b border-black/5 dark:border-white/5 flex justify-between items-center bg-gray-50/50 dark:bg-white/[0.02]">
                    <div>
                        <span class="text-xs font-bold text-neutral-400 uppercase tracking-wider">Detalhes</span>
                        <h3 class="text-xl font-black text-neutral-900 dark:text-white mt-0.5" id="modal-order-id">Pedido #0000</h3>
                        <p class="text-sm text-neutral-500 mt-1" id="modal-order-date">Data</p>
                    </div>
                    <button onclick="toggleOrderDetails()" class="w-10 h-10 rounded-full bg-white dark:bg-white/10 hover:bg-neutral-100 dark:hover:bg-white/20 flex items-center justify-center transition-colors shadow-sm border border-black/5 dark:border-transparent">
                        <i data-lucide="x" class="w-5 h-5 text-neutral-500 dark:text-white"></i>
                    </button>
                </div>
                
                <div class="p-6 overflow-y-auto flex-1">
                    <h4 class="text-xs font-bold text-neutral-500 uppercase tracking-widest mb-4">Itens do Pedido</h4>
                    <div id="modal-order-items" class="space-y-3">
                        <!-- JS Injected -->
                    </div>
                    
                    <div class="mt-8 pt-6 border-t border-black/10 dark:border-white/10 flex justify-between items-end">
                        <span class="text-sm font-medium text-neutral-500">Valor Total</span>
                        <span class="text-3xl font-black text-neutral-900 dark:text-white" id="modal-order-total">R$ 0,00</span>
                    </div>
                </div>
                
                <div class="p-6 bg-gray-50 dark:bg-[#0a0a0a] border-t border-black/5 dark:border-white/5 rounded-b-3xl">
                    <p class="text-xs font-bold text-neutral-400 uppercase tracking-wider mb-3 text-center">Atualizar Status</p>
                    <div class="grid grid-cols-3 gap-3">
                        <button onclick="updateOrderStatusFromModal('Em Preparo')" class="flex flex-col items-center justify-center gap-2 bg-white dark:bg-white/5 hover:bg-blue-50 dark:hover:bg-blue-900/20 border border-black/5 dark:border-white/5 hover:border-blue-200 dark:hover:border-blue-500/30 p-3 rounded-xl transition-all group">
                            <div class="w-8 h-8 rounded-full bg-blue-100 dark:bg-blue-500/20 text-blue-600 dark:text-blue-400 flex items-center justify-center group-hover:scale-110 transition-transform">
                                <i data-lucide="chef-hat" class="w-4 h-4"></i>
                            </div>
                            <span class="text-xs font-bold text-blue-700 dark:text-blue-300">Preparar</span>
                        </button>
                        
                        <button onclick="updateOrderStatusFromModal('Entregue')" class="flex flex-col items-center justify-center gap-2 bg-white dark:bg-white/5 hover:bg-green-50 dark:hover:bg-green-900/20 border border-black/5 dark:border-white/5 hover:border-green-200 dark:hover:border-green-500/30 p-3 rounded-xl transition-all group">
                            <div class="w-8 h-8 rounded-full bg-green-100 dark:bg-green-500/20 text-green-600 dark:text-green-400 flex items-center justify-center group-hover:scale-110 transition-transform">
                                <i data-lucide="check" class="w-4 h-4"></i>
                            </div>
                            <span class="text-xs font-bold text-green-700 dark:text-green-300">Entregar</span>
                        </button>
                        
                        <button onclick="updateOrderStatusFromModal('Cancelado')" class="flex flex-col items-center justify-center gap-2 bg-white dark:bg-white/5 hover:bg-red-50 dark:hover:bg-red-900/20 border border-black/5 dark:border-white/5 hover:border-red-200 dark:hover:border-red-500/30 p-3 rounded-xl transition-all group">
                            <div class="w-8 h-8 rounded-full bg-red-100 dark:bg-red-500/20 text-red-600 dark:text-red-400 flex items-center justify-center group-hover:scale-110 transition-transform">
                                <i data-lucide="x" class="w-4 h-4"></i>
                            </div>
                            <span class="text-xs font-bold text-red-700 dark:text-red-300">Cancelar</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Delete Confirmation Modal -->
        <div id="delete-confirmation-modal" class="fixed inset-0 z-[80] flex items-center justify-center bg-black/80 backdrop-blur-sm hidden animate-fade-in px-4">
            <div class="bg-white dark:bg-[#111] w-full max-w-sm p-6 rounded-3xl shadow-2xl border border-white/10 text-center transform transition-all scale-100">
                <div class="w-16 h-16 bg-red-100 dark:bg-red-900/20 rounded-full flex items-center justify-center mx-auto mb-4 text-red-600 dark:text-red-500 animate-pulse">
                    <i data-lucide="alert-triangle" class="w-8 h-8"></i>
                </div>
                <h3 class="text-xl font-black text-neutral-900 dark:text-white mb-2">Excluir Produto?</h3>
                <p class="text-neutral-500 text-sm mb-6 leading-relaxed">Esta ação não pode ser desfeita. O item será removido permanentemente do cardápio.</p>
                <div class="flex gap-3">
                    <button onclick="closeDeleteModal()" class="flex-1 bg-gray-100 dark:bg-white/5 hover:bg-gray-200 dark:hover:bg-white/10 text-neutral-700 dark:text-white font-bold py-3 rounded-xl transition-colors border border-black/5 dark:border-white/5">
                        CANCELAR
                    </button>
                    <button onclick="confirmDeleteProduct()" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-xl transition-colors shadow-lg shadow-red-600/20 flex items-center justify-center gap-2">
                        <i data-lucide="trash-2" class="w-4 h-4"></i> EXCLUIR
                    </button>
                </div>
            </div>
        </div>

        <!-- Cart Drawer -->
        <div id="cart-drawer" class="fixed inset-0 z-50 pointer-events-none transition-all duration-500">
            <div id="cart-overlay" class="absolute inset-0 bg-black/60 backdrop-blur-sm opacity-0 transition-opacity duration-500" onclick="toggleCart()"></div>
            <div id="cart-panel" class="absolute top-0 right-0 w-full md:w-[500px] h-full bg-white dark:bg-[#0a0a0a] shadow-2xl border-l border-black/5 dark:border-white/5 transform translate-x-full transition-transform duration-500 flex flex-col pointer-events-auto">
                <div class="p-8 pb-4 flex justify-between items-center border-b border-black/5 dark:border-white/5">
                    <div>
                        <h2 class="text-3xl font-black text-neutral-900 dark:text-white tracking-tighter">MEU PEDIDO</h2>
                        <p class="text-neutral-500 text-sm mt-1">Delivery Black Burger</p>
                    </div>
                    <button onclick="toggleCart()" class="w-10 h-10 rounded-full bg-gray-100 dark:bg-white/5 hover:bg-neutral-200 dark:hover:bg-white dark:hover:text-black flex items-center justify-center transition-all text-neutral-600 dark:text-white">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
                <div id="cart-items" class="flex-1 overflow-y-auto p-8 space-y-6"></div>
                <div class="p-8 bg-gray-50 dark:bg-[#0f0f0f] border-t border-black/5 dark:border-white/5">
                    <div class="flex justify-between items-end mb-6">
                        <span class="text-neutral-500 dark:text-neutral-400 font-medium">Subtotal</span>
                        <span class="text-3xl font-black text-neutral-900 dark:text-white">
                            <span class="text-lg text-red-600 dark:text-red-500 mr-1">R$</span>
                            <span id="cart-total">0.00</span>
                        </span>
                    </div>
                    <button id="checkout-btn" onclick="checkoutWhatsApp()" class="w-full py-5 rounded-2xl font-black text-lg flex items-center justify-center gap-3 transition-all transform active:scale-95 bg-gray-200 dark:bg-white/5 text-neutral-400 dark:text-neutral-500 cursor-not-allowed" disabled>
                        ENVIAR PEDIDO <i data-lucide="smartphone" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Logic -->
    <script>
        // --- Dados Iniciais ---
        const initialMenu = [
            { id: 1, active: true, name: "Monster Bacon", description: "Hambúrguer artesanal 180g, muito bacon crocante, queijo cheddar e molho especial BBQ no pão brioche selado na manteiga.", price: 32.90, category: "Sanduíches", image: "https://images.unsplash.com/photo-1594212699903-ec8a3eca50f5?auto=format&fit=crop&q=80&w=800", rating: 4.9, time: "20-25 min", calories: "850 kcal", sales: 150, pairingId: 5, tags: [], options: [{id: 'no_onion', name: 'Sem Cebola', price: 0}, {id: 'extra_bacon', name: 'Bacon Extra', price: 5.00}, {id: 'extra_cheese', name: 'Queijo Extra', price: 3.50}, {id: 'extra_sauce', name: 'Molho Extra', price: 2.00}] },
            { id: 2, active: true, name: "Classic Salad", description: "Hambúrguer 150g, alface americana crocante, tomate fresco, cebola roxa e maionese verde da casa no pão de gergelim.", price: 24.50, category: "Sanduíches", image: "https://images.unsplash.com/photo-1568901346375-23c9450c58cd?auto=format&fit=crop&q=80&w=800", rating: 4.5, time: "15-20 min", calories: "620 kcal", sales: 80, pairingId: 4, tags: [], options: [{id: 'no_onion', name: 'Sem Cebola', price: 0}, {id: 'no_tomato', name: 'Sem Tomate', price: 0}, {id: 'extra_burger', name: 'Hambúrguer Extra', price: 8.00}] },
            { id: 3, active: true, name: "Dark Chicken", description: "Filé de frango empanado no panko escuro (carvão ativado), cream cheese, alface e geleia de pimenta suave.", price: 28.00, category: "Sanduíches", image: "https://images.unsplash.com/photo-1626082927389-6cd097cdc6ec?auto=format&fit=crop&q=80&w=800", rating: 4.7, time: "20-25 min", calories: "710 kcal", sales: 120, pairingId: 4, tags: ['spicy'], options: [{id: 'no_spicy', name: 'Sem Geleia de Pimenta', price: 0}, {id: 'extra_cheese', name: 'Cream Cheese Extra', price: 3.00}] },
            { id: 4, active: true, name: "Coca-Cola Zero", description: "Lata 350ml bem gelada.", price: 6.00, category: "Bebidas", image: "https://images.unsplash.com/photo-1622483767028-3f66f32aef97?auto=format&fit=crop&q=80&w=800", rating: 5.0, time: "Imediato", calories: "0 kcal", sales: 200, tags: ['vegan', 'gluten_free'], options: [] },
            { id: 5, active: true, name: "Fritas Rústicas", description: "Batatas cortadas a mão com casca, temperadas com alecrim, sal grosso e páprica defumada.", price: 18.00, category: "Acompanhamentos", image: "https://images.unsplash.com/photo-1630384060421-a4323ceca041?auto=format&fit=crop&q=80&w=800", rating: 4.8, time: "10-15 min", calories: "400 kcal", sales: 180, tags: ['vegan', 'gluten_free'], options: [{id: 'extra_cheddar', name: 'Cheddar e Bacon', price: 6.00}, {id: 'extra_mayo', name: 'Maionese Extra', price: 2.00}] },
            { id: 6, active: true, name: "Smash Duplo", description: "Dois smash burgers de 90g cada, duplo cheddar, picles artesanal e molho da casa.", price: 26.90, category: "Sanduíches", image: "https://images.unsplash.com/photo-1550547660-d9450f859349?auto=format&fit=crop&q=80&w=800", rating: 4.6, time: "15 min", calories: "750 kcal", sales: 95, tags: [], options: [] }
        ];

        const dietaryTags = [
            { id: 'spicy', label: 'Picante', icon: 'flame', color: 'text-orange-500', border: 'border-orange-500/30', bg: 'bg-orange-500/10' },
            { id: 'vegan', label: 'Vegano', icon: 'leaf', color: 'text-green-500', border: 'border-green-500/30', bg: 'bg-green-500/10' },
            { id: 'gluten_free', label: 'Sem Glúten', icon: 'wheat-off', color: 'text-blue-400', border: 'border-blue-400/30', bg: 'bg-blue-400/10' },
        ];

        const categories = ["Todos", "Sanduíches", "Acompanhamentos", "Bebidas"];

        // --- Estado Global ---
        let state = {
            menu: [...initialMenu],
            cart: [],
            orders: [], // Array de pedidos
            filter: "Todos",
            activeTag: null,
            searchTerm: "",
            isCartOpen: false,
            isAdminLoggedIn: false,
            adminView: 'products', // 'products' ou 'orders'
            selectedProduct: null,
            selectedOptions: {},
            selectedOrder: null,
            productToDeleteId: null,
            currentTable: null // Nova variável para armazenar a mesa
        };

        // --- Inicialização ---
        document.addEventListener('DOMContentLoaded', () => {
            checkTableParam(); // Verifica se há mesa na URL
            loadData(); 
            lucide.createIcons();
            initTheme();
            renderCategories();
            renderFilters();
            renderBestSellers();
            renderMenu();
            renderCart();
            
            // --- MOCK ORDERS (Para visualização) ---
            if (state.orders.length === 0) {
                const today = new Date();
                const yesterday = new Date(today); yesterday.setDate(yesterday.getDate() - 1);
                
                state.orders.push(
                    {
                        id: 1025,
                        date: today.toISOString(),
                        total: 58.90,
                        status: 'Pendente',
                        items: [
                            { name: 'Monster Bacon', quantity: 1, price: 32.90, selectedOptions: [{name: 'Bacon Extra'}]},
                            { name: 'Classic Salad', quantity: 1, price: 24.50, selectedOptions: []}
                        ]
                    },
                    {
                        id: 1024,
                        date: yesterday.toISOString(),
                        total: 32.90,
                        status: 'Entregue',
                        items: [
                            { name: 'Monster Bacon', quantity: 1, price: 32.90, selectedOptions: []}
                        ]
                    }
                );
            }
        });

        // --- MESA LOGIC ---
        function checkTableParam() {
            const urlParams = new URLSearchParams(window.location.search);
            const table = urlParams.get('mesa');
            if (table) {
                state.currentTable = table;
                document.getElementById('table-number-display').innerText = table;
                document.getElementById('table-badge').classList.remove('hidden');
                
                // Ajusta o padding do header para não cobrir o aviso
                document.getElementById('main-header').classList.remove('top-0');
                document.getElementById('main-header').classList.add('top-6');
                document.getElementById('controls-section').classList.remove('top-20');
                document.getElementById('controls-section').classList.add('top-26');
            }
        }

        // --- PERSISTÊNCIA (LOCAL STORAGE) ---
        function loadData() {
            const savedMenu = localStorage.getItem('blackBurgerMenu');
            const savedCart = localStorage.getItem('blackBurgerCart');
            const savedOrders = localStorage.getItem('blackBurgerOrders');
            
            if (savedMenu) {
                state.menu = JSON.parse(savedMenu);
            } else {
                state.menu = [...initialMenu];
                saveData();
            }

            if (savedCart) {
                state.cart = JSON.parse(savedCart);
            }

            if (savedOrders) {
                state.orders = JSON.parse(savedOrders);
            } else {
                state.orders = [];
            }
        }

        function saveData() {
            localStorage.setItem('blackBurgerMenu', JSON.stringify(state.menu));
            localStorage.setItem('blackBurgerCart', JSON.stringify(state.cart));
            localStorage.setItem('blackBurgerOrders', JSON.stringify(state.orders));
        }

        // --- Renderização (Cliente) ---
        function renderCategories() {
            const container = document.getElementById('categories-container');
            container.innerHTML = categories.map(cat => `
                <button onclick="setFilter('${cat}')" 
                    class="px-6 py-2.5 rounded-full text-sm font-bold uppercase tracking-wider transition-all duration-300 whitespace-nowrap flex-shrink-0
                    ${state.filter === cat 
                        ? 'bg-red-600 text-white shadow-lg shadow-red-500/30' 
                        : 'bg-white/80 dark:bg-white/5 border border-black/5 dark:border-white/5 text-neutral-500 dark:text-neutral-400 hover:text-black dark:hover:text-white hover:bg-white/90 dark:hover:bg-white/10 backdrop-blur-sm'}">
                    ${cat}
                </button>
            `).join('');
        }

        function renderFilters() {
            const container = document.getElementById('filters-container');
            container.innerHTML = dietaryTags.map(tag => {
                const isActive = state.activeTag === tag.id;
                return `
                <button onclick="setTag('${tag.id}')"
                    class="flex items-center gap-2 px-3 py-1.5 md:px-4 md:py-2 rounded-xl text-xs md:text-sm font-bold border transition-all duration-300 transform active:scale-95 flex-shrink-0
                    ${isActive
                        ? `${tag.bg} ${tag.border} ${tag.color} shadow-lg ring-1 ring-offset-2 ring-offset-transparent backdrop-blur-md`
                        : 'bg-white/80 dark:bg-white/5 border-black/5 dark:border-white/5 text-neutral-500 dark:text-neutral-400 hover:bg-white/90 dark:hover:bg-white/10 backdrop-blur-sm'}">
                    <i data-lucide="${tag.icon}" class="w-3.5 h-3.5"></i> ${tag.label}
                    ${isActive ? '<i data-lucide="check" class="w-3.5 h-3.5 ml-1"></i>' : ''}
                </button>
            `}).join('');
            lucide.createIcons();
        }

        function setFilter(cat) {
            state.filter = cat;
            renderCategories();
            renderBestSellers();
            renderMenu();
        }

        function setTag(tagId) {
            state.activeTag = state.activeTag === tagId ? null : tagId;
            renderFilters();
            renderBestSellers();
            renderMenu();
        }

        function renderBestSellers() {
            const section = document.getElementById('best-sellers-section');
            if (state.filter !== "Todos" || state.activeTag !== null || state.searchTerm !== "") {
                section.classList.add('hidden');
                return;
            }
            section.classList.remove('hidden');

            const container = document.getElementById('best-sellers-grid');
            const popular = [...state.menu].filter(item => item.active !== false).slice(0, 5);
            
            if (popular.length === 0) {
                container.innerHTML = `<p class="text-neutral-500 w-full text-center">Nenhum item em destaque.</p>`;
                return;
            }

            container.innerHTML = popular.map((item, index) => `
                <div onclick="openDetails(${item.id})" class="flex-shrink-0 w-28 md:w-32 snap-center flex flex-col items-center group cursor-pointer animate-fade-in">
                    <div class="relative mb-3">
                        <div class="absolute -top-1 -right-1 z-20 w-7 h-7 bg-yellow-500 text-black font-black flex items-center justify-center rounded-full shadow-lg border-2 border-white dark:border-[#050505] text-xs">#${index + 1}</div>
                        <div class="w-24 h-24 md:w-28 md:h-28 rounded-full p-1 border-2 border-yellow-500/30 group-hover:border-yellow-500 transition-all duration-300 shadow-lg dark:shadow-none bg-white/90 dark:bg-neutral-900/90 backdrop-blur-sm group-hover:scale-105">
                            <div class="w-full h-full rounded-full overflow-hidden relative">
                                <img src="${item.image}" alt="${item.name}" class="w-full h-full object-cover" onerror="this.src='https://placehold.co/400x300/1a1a1a/red?text=Indispon%C3%ADvel'">
                            </div>
                        </div>
                    </div>
                    <div class="text-center w-full px-1">
                        <p class="font-bold text-xs md:text-sm leading-tight text-neutral-900 dark:text-white line-clamp-2 h-8 group-hover:text-red-500 transition-colors drop-shadow-sm">${item.name}</p>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function renderMenu() {
            const container = document.getElementById('products-grid');
            const title = document.getElementById('menu-title');
            const emptyState = document.getElementById('empty-state');

            let filtered = state.menu.filter(item => {
                const matchesCategory = state.filter === "Todos" || item.category === state.filter;
                const matchesTag = state.activeTag === null || (item.tags && item.tags.includes(state.activeTag));
                const term = state.searchTerm.toLowerCase();
                const matchesSearch = term === "" || item.name.toLowerCase().includes(term) || item.description.toLowerCase().includes(term);
                const isActive = item.active !== false; 
                return matchesCategory && matchesTag && matchesSearch && isActive;
            });

            if (state.searchTerm) title.innerText = `RESULTADOS PARA: "${state.searchTerm}"`;
            else if (state.filter !== "Todos") title.innerText = `CATEGORIA: ${state.filter}`;
            else title.innerText = 'CARDÁPIO COMPLETO';

            if (filtered.length === 0) {
                container.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }
            emptyState.classList.add('hidden');

            container.innerHTML = filtered.map(item => {
                let tagsHtml = '';
                if (item.tags && item.tags.length > 0) {
                    tagsHtml = `<div class="flex gap-1 mt-1 justify-end">` + 
                        item.tags.map(tagId => {
                            const t = dietaryTags.find(dt => dt.id === tagId);
                            return t ? `<div class="w-6 h-6 rounded-full flex items-center justify-center ${t.bg} ${t.color} border ${t.border} backdrop-blur-md shadow-sm" title="${t.label}"><i data-lucide="${t.icon}" class="w-3 h-3"></i></div>` : '';
                        }).join('') + 
                    `</div>`;
                }

                return `
                <div onclick="openDetails(${item.id})" class="group relative bg-white/90 dark:bg-[#0f0f0f]/80 backdrop-blur-md rounded-[2rem] p-4 cursor-pointer hover:bg-white dark:hover:bg-black transition-colors duration-500 border border-black/5 dark:border-white/5 hover:border-red-500/30 shadow-lg dark:shadow-none animate-fade-in">
                    <div class="aspect-[4/3] rounded-[1.5rem] overflow-hidden mb-4 relative bg-gray-100 dark:bg-black">
                        <div class="absolute inset-0 bg-red-600/0 group-hover:bg-red-600/10 transition-colors z-10 duration-500"></div>
                        <img src="${item.image}" alt="${item.name}" class="w-full h-full object-cover transform group-hover:scale-110 transition-transform duration-700 ease-in-out" onerror="this.src='https://placehold.co/400x300/1a1a1a/red?text=Indispon%C3%ADvel'">
                        <div class="absolute top-3 right-3 z-20 flex flex-col items-end gap-1">
                            <div class="bg-white/80 dark:bg-black/60 backdrop-blur-md px-2 py-1 rounded-lg flex items-center gap-1 border border-black/5 dark:border-white/10 shadow-sm">
                                <i data-lucide="star" class="w-3 h-3 text-yellow-500 fill-yellow-500"></i>
                                <span class="text-xs font-bold text-neutral-900 dark:text-white">${item.rating}</span>
                            </div>
                            ${tagsHtml}
                        </div>
                    </div>
                    <div class="px-2 pb-2">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="text-xl font-bold text-neutral-900 dark:text-white tracking-tight group-hover:text-red-600 dark:group-hover:text-red-500 transition-colors duration-300">${item.name}</h3>
                            <span class="text-lg font-bold text-red-600 dark:text-red-500 bg-red-50 dark:bg-red-500/10 px-2 py-1 rounded-lg whitespace-nowrap">
                                R$ ${Math.floor(item.price)}<span class="text-xs align-top">,${(item.price % 1).toFixed(2).split('.')[1]}</span>
                            </span>
                        </div>
                        <p class="text-neutral-500 dark:text-neutral-500 text-sm leading-relaxed mb-6 line-clamp-2 h-10">${item.description}</p>
                        <button class="w-full h-12 rounded-xl bg-neutral-100 dark:bg-white/5 hover:bg-neutral-900 dark:hover:bg-white text-neutral-900 dark:text-white hover:text-white dark:hover:text-black font-bold flex items-center justify-between px-4 transition-all duration-300 group/btn border border-black/5 dark:border-white/5 hover:border-transparent">
                            <span class="text-sm">VER DETALHES</span>
                            <div class="bg-white dark:bg-white/10 group-hover/btn:bg-white/20 dark:group-hover/btn:bg-black group-hover/btn:text-white p-1.5 rounded-lg transition-colors">
                                <i data-lucide="plus" class="w-4 h-4"></i>
                            </div>
                        </button>
                    </div>
                </div>
            `}).join('');
            lucide.createIcons();
        }

        // --- Live Search ---
        function handleSearch(value) {
            state.searchTerm = value;
            openSearchMode();
            renderBestSellers();
            renderMenu();
        }

        function openSearchMode() {
            document.getElementById('search-filters-wrapper').classList.remove('hidden');
            document.getElementById('search-close-btn').classList.remove('hidden');
        }

        function closeSearchMode() {
            document.getElementById('search-filters-wrapper').classList.add('hidden');
            document.getElementById('search-close-btn').classList.add('hidden');
            document.getElementById('search-input').value = '';
            state.searchTerm = '';
            state.filter = 'Todos';
            state.activeTag = null;
            renderCategories();
            renderFilters();
            renderBestSellers();
            renderMenu();
        }

        // --- Detalhes do Produto ---
        function openDetails(productId) {
            const product = state.menu.find(p => p.id === productId);
            if (!product) return;
            state.selectedProduct = product;
            state.selectedOptions = {};
            document.getElementById('main-view').classList.add('hidden');
            document.getElementById('details-view').classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
            renderDetailsContent();
        }

        function closeDetails() {
            state.selectedProduct = null;
            document.getElementById('main-view').classList.remove('hidden');
            document.getElementById('details-view').classList.add('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function toggleOption(optionId) {
            if (state.selectedOptions[optionId]) delete state.selectedOptions[optionId];
            else state.selectedOptions[optionId] = true;
            renderDetailsContent();
        }

        function getCustomizedPrice(product, options) {
            let total = product.price;
            if (product.options) product.options.forEach(opt => { if (options[opt.id]) total += opt.price; });
            return total;
        }

        function renderDetailsContent() {
            const product = state.selectedProduct;
            const container = document.getElementById('details-content');
            const currentPrice = getCustomizedPrice(product, state.selectedOptions);
            
            let optionsHtml = '';
            if (product.options && product.options.length > 0) {
                optionsHtml = `<div class="mb-8"><h3 class="text-sm font-bold text-neutral-500 uppercase tracking-wider mb-4 flex items-center gap-2"><i data-lucide="edit-3" class="w-3.5 h-3.5"></i> Personalize seu pedido</h3><div class="space-y-3">` +
                product.options.map(opt => {
                    const isSelected = !!state.selectedOptions[opt.id];
                    return `
                    <div onclick="toggleOption('${opt.id}')" class="flex items-center justify-between p-4 rounded-xl border cursor-pointer transition-all duration-200 group ${isSelected ? 'border-red-500 bg-red-50 dark:bg-red-500/10 shadow-md' : 'border-black/5 dark:border-white/10 bg-white dark:bg-white/5 hover:border-red-200 dark:hover:border-white/20'}">
                        <div class="flex items-center gap-4">
                            <div class="w-6 h-6 rounded-lg border flex items-center justify-center transition-colors ${isSelected ? 'bg-red-600 dark:bg-red-500 border-red-600 dark:border-red-500' : 'border-neutral-300 dark:border-neutral-600 group-hover:border-neutral-400'}">
                                ${isSelected ? '<i data-lucide="check" class="w-3.5 h-3.5 text-white"></i>' : ''}
                            </div>
                            <span class="font-medium transition-colors ${isSelected ? 'text-red-700 dark:text-white' : 'text-neutral-700 dark:text-neutral-300'}">${opt.name}</span>
                        </div>
                        <span class="text-sm font-bold ${opt.price > 0 ? 'text-red-600 dark:text-red-500' : 'text-green-600 dark:text-green-500'}">${opt.price > 0 ? '+ R$ ' + opt.price.toFixed(2) : 'Grátis'}</span>
                    </div>`;
                }).join('') + `</div></div>`;
            }

            container.innerHTML = `
                <div class="lg:col-span-7 relative group lg:sticky lg:top-24">
                    <div class="relative rounded-[3rem] overflow-hidden aspect-[4/3] border border-black/10 dark:border-white/10 shadow-2xl bg-white dark:bg-[#0f0f0f]">
                        <img src="${product.image}" class="w-full h-full object-cover scale-105 group-hover:scale-100 transition-transform duration-700" onerror="this.src='https://placehold.co/600x400/1a1a1a/red?text=Indispon%C3%ADvel'">
                    </div>
                </div>
                <div class="lg:col-span-5 flex flex-col">
                    <div class="flex items-center gap-3 mb-4">
                        <span class="px-3 py-1 rounded-full border border-red-500/30 bg-red-500/10 text-red-600 dark:text-red-500 text-xs font-bold uppercase tracking-wider backdrop-blur-md">${product.category}</span>
                        <div class="flex items-center gap-1 text-yellow-500 dark:text-yellow-400 ml-auto lg:ml-0 drop-shadow-sm">
                            <i data-lucide="star" class="w-3.5 h-3.5 fill-current"></i>
                            <span class="text-sm font-bold text-neutral-900 dark:text-white">${product.rating}</span>
                        </div>
                    </div>
                    <h2 class="text-4xl md:text-6xl font-black mb-6 leading-[0.9] tracking-tighter text-neutral-900 dark:text-white drop-shadow-md">${product.name}</h2>
                    <p class="text-neutral-600 dark:text-neutral-300 text-lg leading-relaxed mb-6 font-medium">${product.description}</p>
                    ${optionsHtml}
                    <div class="sticky bottom-4 z-20 mt-auto">
                        <div class="bg-white/90 dark:bg-[#0f0f0f]/90 backdrop-blur-xl p-4 rounded-3xl border border-black/5 dark:border-white/10 shadow-2xl">
                            <div class="flex items-center gap-6">
                                <div>
                                    <span class="block text-sm text-neutral-500 mb-1">Total do Item</span>
                                    <span class="text-3xl font-black text-neutral-900 dark:text-white tracking-tight">
                                        <span class="text-base align-top text-red-600 dark:text-red-500 font-bold mr-1">R$</span>${currentPrice.toFixed(2)}
                                    </span>
                                </div>
                                <button onclick="addToCart()" class="flex-1 bg-neutral-900 dark:bg-white text-white dark:text-black hover:bg-red-600 dark:hover:bg-red-600 hover:text-white dark:hover:text-white h-16 rounded-2xl font-black text-lg flex items-center justify-center gap-2 transition-all duration-300 shadow-xl hover:shadow-red-900/40 hover:-translate-y-1">
                                    ADICIONAR <i data-lucide="plus" class="w-6 h-6"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        // --- Carrinho ---
        function toggleCart() {
            const drawer = document.getElementById('cart-panel');
            const overlay = document.getElementById('cart-overlay');
            const cartDrawer = document.getElementById('cart-drawer');
            state.isCartOpen = !state.isCartOpen;
            if (state.isCartOpen) {
                cartDrawer.classList.remove('pointer-events-none');
                drawer.classList.remove('translate-x-full');
                overlay.classList.remove('opacity-0');
            } else {
                cartDrawer.classList.add('pointer-events-none');
                drawer.classList.add('translate-x-full');
                overlay.classList.add('opacity-0');
            }
        }

        function addToCart() {
            const product = state.selectedProduct;
            const options = state.selectedOptions;
            const activeOptionKeys = Object.keys(options).filter(k => options[k]);
            const uniqueId = `${product.id}-${activeOptionKeys.sort().join('-')}`;
            const price = getCustomizedPrice(product, options);
            const displayOptions = activeOptionKeys.map(key => product.options.find(o => o.id === key)).filter(Boolean);

            const existing = state.cart.find(item => item.uniqueId === uniqueId);
            if (existing) existing.quantity += 1;
            else state.cart.push({ ...product, uniqueId, quantity: 1, price, selectedOptions: displayOptions });

            saveData(); // Save to localStorage
            renderCart();
            toggleCart();
        }

        function removeFromCart(uniqueId) {
            state.cart = state.cart.filter(item => item.uniqueId !== uniqueId);
            saveData(); // Save to localStorage
            renderCart();
        }

        function updateQuantity(uniqueId, delta) {
            state.cart = state.cart.map(item => {
                if (item.uniqueId === uniqueId) {
                    const newQty = item.quantity + delta;
                    return newQty > 0 ? { ...item, quantity: newQty } : item;
                }
                return item;
            });
            saveData(); // Save to localStorage
            renderCart();
        }

        function renderCart() {
            const container = document.getElementById('cart-items');
            const countBadge = document.getElementById('cart-count');
            const totalEl = document.getElementById('cart-total');
            const checkoutBtn = document.getElementById('checkout-btn');
            const total = state.cart.reduce((acc, item) => acc + (item.price * item.quantity), 0);
            const count = state.cart.reduce((acc, item) => acc + item.quantity, 0);

            if (count > 0) { countBadge.innerText = count; countBadge.classList.remove('hidden'); }
            else countBadge.classList.add('hidden');
            totalEl.innerText = total.toFixed(2);
            
            if (state.cart.length === 0) {
                container.innerHTML = `<div class="h-full flex flex-col items-center justify-center text-neutral-500 gap-4 opacity-50"><div class="w-20 h-20 rounded-full bg-gray-100 dark:bg-white/5 flex items-center justify-center"><i data-lucide="shopping-cart" class="w-8 h-8"></i></div><p class="font-medium">Sua sacola está vazia</p></div>`;
                checkoutBtn.disabled = true;
                checkoutBtn.classList.add('bg-gray-200', 'dark:bg-white/5', 'text-neutral-400', 'cursor-not-allowed');
                checkoutBtn.classList.remove('bg-green-600');
            } else {
                checkoutBtn.disabled = false;
                checkoutBtn.classList.remove('bg-gray-200', 'dark:bg-white/5', 'text-neutral-400', 'cursor-not-allowed');
                checkoutBtn.classList.add('bg-green-600');
                container.innerHTML = state.cart.map(item => `
                    <div class="flex gap-5 items-start group animate-fade-in">
                        <div class="w-20 h-20 rounded-2xl overflow-hidden bg-gray-100 dark:bg-neutral-900 shrink-0 mt-1 border border-black/5 dark:border-transparent">
                            <img src="${item.image}" class="w-full h-full object-cover opacity-90 group-hover:opacity-100 transition-opacity" onerror="this.src='https://placehold.co/100x100/1a1a1a/red?text=Erro'">
                        </div>
                        <div class="flex-1">
                            <div class="flex justify-between items-start mb-1">
                                <h4 class="font-bold text-neutral-900 dark:text-white text-lg leading-tight">${item.name}</h4>
                                <button onclick="removeFromCart('${item.uniqueId}')" class="text-neutral-400 hover:text-red-500 transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </div>
                            ${item.selectedOptions && item.selectedOptions.length > 0 ? `<div class="flex flex-wrap gap-1 mb-2">` + item.selectedOptions.map(opt => `<span class="text-xs text-neutral-500 dark:text-neutral-400 bg-gray-100 dark:bg-white/5 px-2 py-0.5 rounded border border-black/5 dark:border-white/5">${opt.name}</span>`).join('') + `</div>` : ''}
                            <p class="text-red-600 dark:text-red-500 font-bold mb-3">R$ ${(item.price * item.quantity).toFixed(2)}</p>
                            <div class="flex items-center gap-4 bg-gray-100 dark:bg-white/5 w-max px-3 py-1.5 rounded-lg border border-black/5 dark:border-white/5">
                                <button onclick="updateQuantity('${item.uniqueId}', -1)" class="text-neutral-600 dark:text-white hover:text-red-500 text-lg leading-none pb-0.5">-</button>
                                <span class="text-sm font-bold text-neutral-900 dark:text-white w-4 text-center">${item.quantity}</span>
                                <button onclick="updateQuantity('${item.uniqueId}', 1)" class="text-neutral-600 dark:text-white hover:text-green-500 text-lg leading-none pb-0.5">+</button>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
            lucide.createIcons();
        }

        // --- Checkout com Salvar Pedido ---
        function checkoutWhatsApp() {
            if (state.cart.length === 0) return;
            const total = state.cart.reduce((acc, item) => acc + (item.price * item.quantity), 0);
            
            // Cria o pedido para o Admin
            const newOrder = {
                id: Math.floor(Math.random() * 10000) + 1000,
                date: new Date().toISOString(),
                total: total,
                status: 'Pendente',
                items: JSON.parse(JSON.stringify(state.cart)), // Copia profunda
                table: state.currentTable // Adiciona info da mesa
            };

            // Adiciona ao início da lista
            state.orders.unshift(newOrder);

            // Monta msg WhatsApp
            let message = "";
            
            // Cabeçalho personalizado com MESA se existir
            if(state.currentTable) {
                message += `*PEDIDO MESA ${state.currentTable} - BLACK BURGER*\n\n`;
            } else {
                message += "*PEDIDO - BLACK BURGER*\n\n";
            }

            state.cart.forEach(item => {
                message += `${item.quantity}x ${item.name}`;
                if (item.selectedOptions && item.selectedOptions.length > 0) message += `\n   Obs: ${item.selectedOptions.map(opt => opt.name).join(', ')}`;
                message += ` - R$ ${(item.price * item.quantity).toFixed(2)}\n----------------\n`;
            });
            message += `\n*Total: R$ ${total.toFixed(2)}*`;
            
            // Abre WhatsApp
            window.open(`https://wa.me/5500000000000?text=${encodeURIComponent(message)}`, '_blank');
            
            // Limpa carrinho
            state.cart = [];
            saveData();
            renderCart();
            toggleCart();
        }

        // --- SISTEMA ADMINISTRATIVO ---

        function toggleLoginModal() {
            const modal = document.getElementById('login-modal');
            if (modal.classList.contains('hidden')) {
                modal.classList.remove('hidden');
            } else {
                modal.classList.add('hidden');
                document.getElementById('login-user').value = '';
                document.getElementById('login-pass').value = '';
            }
        }

        function handleLogin(e) {
            e.preventDefault();
            const user = document.getElementById('login-user').value;
            const pass = document.getElementById('login-pass').value;
            if (user === 'admin' && pass === 'admin') {
                state.isAdminLoggedIn = true;
                toggleLoginModal();
                toggleAdminDashboard();
            } else {
                alert("Credenciais inválidas! (Tente admin / admin)");
            }
        }

        function toggleAdminDashboard() {
            const dashboard = document.getElementById('admin-dashboard');
            
            if (state.isAdminLoggedIn) {
                if (dashboard.classList.contains('hidden')) {
                    dashboard.classList.remove('hidden');
                    switchAdminView('products'); // Default view
                } else {
                    dashboard.classList.add('hidden');
                    state.isAdminLoggedIn = false;
                }
            } else {
                dashboard.classList.add('hidden');
            }
        }

        function switchAdminView(view) {
            state.adminView = view;
            const tabProducts = document.getElementById('tab-products');
            const tabOrders = document.getElementById('tab-orders');
            const tabQR = document.getElementById('tab-qr');
            
            const viewProducts = document.getElementById('admin-view-products');
            const viewOrders = document.getElementById('admin-view-orders');
            const viewQR = document.getElementById('admin-view-qr');

            // Reset all tabs
            [tabProducts, tabOrders, tabQR].forEach(tab => {
                tab.classList.remove('border-red-600', 'text-red-600', 'dark:text-white');
                tab.classList.add('border-transparent', 'text-neutral-500');
            });
            
            // Hide all views
            viewProducts.classList.add('hidden');
            viewOrders.classList.add('hidden');
            viewQR.classList.add('hidden');

            // Activate selected
            if (view === 'products') {
                tabProducts.classList.add('border-red-600', 'text-red-600', 'dark:text-white');
                tabProducts.classList.remove('border-transparent', 'text-neutral-500');
                viewProducts.classList.remove('hidden');
                renderAdminList();
            } else if (view === 'orders') {
                tabOrders.classList.add('border-red-600', 'text-red-600', 'dark:text-white');
                tabOrders.classList.remove('border-transparent', 'text-neutral-500');
                viewOrders.classList.remove('hidden');
                renderAdminOrders();
            } else if (view === 'qr') {
                tabQR.classList.add('border-red-600', 'text-red-600', 'dark:text-white');
                tabQR.classList.remove('border-transparent', 'text-neutral-500');
                viewQR.classList.remove('hidden');
            }
        }

        // --- QR Code Generator Logic ---
        function generateQRCode() {
            const num = document.getElementById('qr-table-num').value;
            if(!num) return alert("Digite o número da mesa!");

            const container = document.getElementById('qrcode-container');
            container.innerHTML = ""; // Clear previous

            // URL Base (Na vida real, seria seu domínio. Aqui usamos o local)
            const baseUrl = window.location.href.split('?')[0]; 
            const finalUrl = `${baseUrl}?mesa=${num}`;

            new QRCode(container, {
                text: finalUrl,
                width: 200,
                height: 200,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });

            document.getElementById('qr-display-num').innerText = num;
            document.getElementById('qr-result-area').classList.remove('hidden');
        }

        function printQRCode() {
            const printWindow = window.open('', '', 'height=600,width=800');
            const qrHTML = document.getElementById('qrcode-container').innerHTML;
            const num = document.getElementById('qr-display-num').innerText;

            printWindow.document.write('<html><head><title>Mesa ' + num + '</title>');
            printWindow.document.write('</head><body style="text-align:center; font-family:sans-serif;">');
            printWindow.document.write('<h1>Mesa ' + num + '</h1>');
            printWindow.document.write('<div style="display:inline-block; margin:20px;">' + qrHTML + '</div>');
            printWindow.document.write('<p>Escaneie para pedir</p>');
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.print();
        }

        // --- Admin: Gestão de Pedidos & Dashboard ---

        function renderAdminOrders() {
            const list = document.getElementById('admin-orders-list');
            const filterStatus = document.getElementById('order-filter-status').value;
            const filterStart = document.getElementById('order-filter-start').value;
            const filterEnd = document.getElementById('order-filter-end').value;
            const noOrders = document.getElementById('no-orders-msg');

            // --- FILTERING LOGIC ---
            let filteredOrders = state.orders.filter(o => {
                const oDate = new Date(o.date);
                
                // Status Filter
                const matchStatus = filterStatus === 'all' || o.status === filterStatus;
                
                // Date Filter
                let matchDate = true;
                
                // CORREÇÃO: Criar datas baseadas nos componentes locais (Ano, Mês, Dia)
                // para evitar problemas de fuso horário (UTC vs Local)
                if (filterStart) {
                    const parts = filterStart.split('-');
                    // new Date(ano, mes-1, dia) cria data à meia-noite local
                    const start = new Date(parts[0], parts[1] - 1, parts[2]); 
                    matchDate = matchDate && oDate >= start;
                }
                
                if (filterEnd) {
                    const parts = filterEnd.split('-');
                    const end = new Date(parts[0], parts[1] - 1, parts[2]);
                    // Define o final do dia selecionado (23:59:59.999)
                    end.setHours(23, 59, 59, 999);
                    matchDate = matchDate && oDate <= end;
                }

                return matchStatus && matchDate;
            });

            // --- DASHBOARD CALCULATION ---
            const totalRevenue = filteredOrders.reduce((sum, o) => sum + o.total, 0);
            const totalCount = filteredOrders.length;
            const avgTicket = totalCount > 0 ? totalRevenue / totalCount : 0;
            const deliveredCount = filteredOrders.filter(o => o.status === 'Entregue').length;
            const conversionRate = totalCount > 0 ? (deliveredCount / totalCount) * 100 : 0;

            // Update DOM
            document.getElementById('dash-total-revenue').innerText = `R$ ${totalRevenue.toFixed(2)}`;
            document.getElementById('dash-total-count').innerText = totalCount;
            document.getElementById('dash-avg-ticket').innerText = `R$ ${avgTicket.toFixed(2)}`;
            document.getElementById('dash-conversion').innerText = `${conversionRate.toFixed(0)}%`;


            // --- LIST RENDERING ---
            if (filteredOrders.length === 0) {
                list.innerHTML = '';
                noOrders.classList.remove('hidden');
                return;
            }
            noOrders.classList.add('hidden');

            const statusColors = {
                'Pendente': 'bg-yellow-100 text-yellow-700 border-yellow-200',
                'Em Preparo': 'bg-blue-100 text-blue-700 border-blue-200',
                'Entregue': 'bg-green-100 text-green-700 border-green-200',
                'Cancelado': 'bg-red-100 text-red-700 border-red-200'
            };

            list.innerHTML = filteredOrders.map(order => `
                <tr class="hover:bg-black/5 dark:hover:bg-white/5 transition-colors border-b border-black/5 dark:border-white/5 last:border-0">
                    <td class="p-4 pl-6 font-mono text-xs font-bold text-neutral-500">
                        #${order.id}
                        ${order.table ? `<span class="ml-2 bg-purple-100 text-purple-700 px-1.5 py-0.5 rounded text-[10px]">Mesa ${order.table}</span>` : ''}
                    </td>
                    <td class="p-4">
                        <div class="text-sm font-bold text-neutral-900 dark:text-white">${new Date(order.date).toLocaleDateString('pt-BR')}</div>
                        <div class="text-xs text-neutral-500">${new Date(order.date).toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'})}</div>
                    </td>
                    <td class="p-4 font-bold text-neutral-900 dark:text-white">R$ ${order.total.toFixed(2)}</td>
                    <td class="p-4">
                        <span class="px-2 py-1 rounded-full text-xs font-bold border ${statusColors[order.status] || 'bg-gray-100'}">
                            ${order.status}
                        </span>
                    </td>
                    <td class="p-4 pr-6 text-right">
                        <button onclick="viewOrderDetails(${order.id})" class="text-neutral-500 hover:text-red-600 transition-colors" title="Ver Detalhes">
                            <i data-lucide="eye" class="w-5 h-5"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            lucide.createIcons();
        }

        function handleOrderFilter() {
            renderAdminOrders();
        }

        function viewOrderDetails(orderId) {
            const order = state.orders.find(o => o.id === orderId);
            if (!order) return;
            state.selectedOrder = order;

            // Se tiver mesa, mostra no título do modal
            const tableText = order.table ? ` (Mesa ${order.table})` : '';
            document.getElementById('modal-order-id').innerText = `Pedido #${order.id}${tableText}`;
            
            document.getElementById('modal-order-date').innerText = new Date(order.date).toLocaleString('pt-BR');
            document.getElementById('modal-order-total').innerText = `R$ ${order.total.toFixed(2)}`;

            const itemsContainer = document.getElementById('modal-order-items');
            itemsContainer.innerHTML = order.items.map(item => `
                <div class="flex justify-between items-start border-b border-black/5 dark:border-white/5 pb-2 last:border-0">
                    <div>
                        <span class="font-bold text-neutral-900 dark:text-white">${item.quantity}x ${item.name}</span>
                        ${item.selectedOptions && item.selectedOptions.length > 0 
                            ? `<div class="text-xs text-neutral-500 mt-1">${item.selectedOptions.map(o => o.name).join(', ')}</div>` 
                            : ''}
                    </div>
                    <span class="text-sm font-bold text-neutral-700 dark:text-neutral-300">R$ ${(item.price * item.quantity).toFixed(2)}</span>
                </div>
            `).join('');

            document.getElementById('order-details-modal').classList.remove('hidden');
        }

        function toggleOrderDetails() {
            document.getElementById('order-details-modal').classList.add('hidden');
            state.selectedOrder = null;
        }

        function updateOrderStatusFromModal(newStatus) {
            if (!state.selectedOrder) return;
            state.selectedOrder.status = newStatus;
            
            // Re-render
            viewOrderDetails(state.selectedOrder.id); // Update modal UI if needed (though buttons stay same)
            renderAdminOrders(); // Update list
            toggleOrderDetails(); // Close modal
            saveData();
        }


        // --- Admin: Gestão de Produtos ---

        function renderAdminList() {
            const tbody = document.getElementById('admin-products-list');
            const badge = document.getElementById('total-items-badge');
            
            badge.innerText = `${state.menu.length} itens`;
            
            tbody.innerHTML = state.menu.map(item => `
                <tr class="hover:bg-black/5 dark:hover:bg-white/5 transition-colors group ${item.active === false ? 'opacity-50' : ''}">
                    <td class="p-4 pl-6">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-lg overflow-hidden border border-black/10 dark:border-white/10">
                                <img src="${item.image}" class="w-full h-full object-cover" onerror="this.src='https://placehold.co/100x100/1a1a1a/red?text=Erro'">
                            </div>
                            <span class="font-bold text-neutral-900 dark:text-white">${item.name}</span>
                        </div>
                    </td>
                    <td class="p-4 text-neutral-500">${item.category}</td>
                    <td class="p-4 font-bold text-neutral-900 dark:text-white">R$ ${item.price.toFixed(2)}</td>
                    <td class="p-4 pr-6 text-right">
                        <div class="flex justify-end gap-2">
                            <button onclick="toggleProductActive(${item.id})" class="p-2 ${item.active !== false ? 'bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400' : 'bg-gray-200 dark:bg-white/10 text-neutral-400'} rounded-lg hover:opacity-80 transition-colors" title="${item.active !== false ? 'Desativar' : 'Ativar'}">
                                <i data-lucide="${item.active !== false ? 'eye' : 'eye-off'}" class="w-4 h-4"></i>
                            </button>
                            <button onclick="editProduct(${item.id})" class="p-2 bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 rounded-lg hover:bg-blue-200 dark:hover:bg-blue-900/50 transition-colors" title="Editar">
                                <i data-lucide="pencil" class="w-4 h-4"></i>
                            </button>
                            <button onclick="openDeleteModal(${item.id})" class="p-2 bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 rounded-lg hover:bg-red-200 dark:hover:bg-red-900/50 transition-colors" title="Excluir">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
            lucide.createIcons();
        }

        // Toggle Active Status
        function toggleProductActive(id) {
            const product = state.menu.find(p => p.id === id);
            if (product) {
                // Toggle active state (undefined or true -> false, false -> true)
                product.active = product.active === false; 
                renderAdminList();
                renderMenu();
                renderBestSellers();
            }
        }

        // --- Lógica do Modal de Exclusão ---

        function openDeleteModal(id) {
            state.productToDeleteId = id;
            document.getElementById('delete-confirmation-modal').classList.remove('hidden');
        }

        function closeDeleteModal() {
            state.productToDeleteId = null;
            document.getElementById('delete-confirmation-modal').classList.add('hidden');
        }

        function confirmDeleteProduct() {
            if (state.productToDeleteId) {
                state.menu = state.menu.filter(p => p.id !== state.productToDeleteId);
                
                // Atualiza todas as views
                renderAdminList();
                renderMenu(); 
                renderBestSellers();
            }
            closeDeleteModal();
        }

        // Editar Produto (Preenche o formulário)
        function editProduct(id) {
            const item = state.menu.find(p => p.id === id);
            if (!item) return;

            document.getElementById('edit-id').value = item.id;
            document.getElementById('admin-name').value = item.name;
            document.getElementById('admin-price').value = item.price;
            document.getElementById('admin-image').value = item.image;
            document.getElementById('admin-desc').value = item.description;
            document.getElementById('admin-cat').value = item.category;

            // Reset Tags Checkboxes
            document.getElementById('admin-tag-spicy').checked = false;
            document.getElementById('admin-tag-vegan').checked = false;
            document.getElementById('admin-tag-gluten_free').checked = false;

            // Check Tags based on item data
            if (item.tags) {
                if (item.tags.includes('spicy')) document.getElementById('admin-tag-spicy').checked = true;
                if (item.tags.includes('vegan')) document.getElementById('admin-tag-vegan').checked = true;
                if (item.tags.includes('gluten_free')) document.getElementById('admin-tag-gluten_free').checked = true;
            }

            // Altera UI para modo edição
            document.getElementById('form-title').innerText = "Editar Item";
            document.getElementById('save-btn').innerHTML = `<i data-lucide="refresh-cw" class="w-4 h-4"></i> ATUALIZAR`;
            
            // Scroll para o topo do form
            const dashboard = document.getElementById('admin-dashboard');
            dashboard.scrollTo({ top: 0, behavior: 'smooth' });
            lucide.createIcons();
        }

        function resetForm() {
            document.querySelector('form').reset();
            document.getElementById('edit-id').value = '';
            document.getElementById('form-title').innerText = "Adicionar Novo Item";
            document.getElementById('save-btn').innerHTML = `<i data-lucide="save" class="w-4 h-4"></i> SALVAR PRODUTO`;
            
            // Reset Tags Manually
            document.getElementById('admin-tag-spicy').checked = false;
            document.getElementById('admin-tag-vegan').checked = false;
            document.getElementById('admin-tag-gluten_free').checked = false;
            
            lucide.createIcons();
        }

        // Salvar (Criar ou Atualizar)
        function handleSaveProduct(e) {
            e.preventDefault();
            const id = document.getElementById('edit-id').value;
            const name = document.getElementById('admin-name').value;
            const price = parseFloat(document.getElementById('admin-price').value);
            let image = document.getElementById('admin-image').value;
            const desc = document.getElementById('admin-desc').value;
            const cat = document.getElementById('admin-cat').value;

            // CORREÇÃO IMGUR: Auto-converter links de post para links diretos de imagem
            // Ex: https://imgur.com/codigo -> https://i.imgur.com/codigo.jpg
            if (image && image.includes('imgur.com') && !image.includes('i.imgur.com')) {
                 const match = image.match(/imgur\.com\/([a-zA-Z0-9]{5,})/);
                 if (match && match[1] && !image.includes('/a/') && !image.includes('/gallery/')) {
                     image = `https://i.imgur.com/${match[1]}.jpg`;
                 }
            }

            // Capture Tags
            const tags = [];
            if (document.getElementById('admin-tag-spicy').checked) tags.push('spicy');
            if (document.getElementById('admin-tag-vegan').checked) tags.push('vegan');
            if (document.getElementById('admin-tag-gluten_free').checked) tags.push('gluten_free');

            if (id) {
                // Atualizar Existente
                const index = state.menu.findIndex(p => p.id == id);
                if (index !== -1) {
                    state.menu[index] = {
                        ...state.menu[index],
                        name, price, image, description: desc, category: cat, tags: tags
                    };
                }
            } else {
                // Criar Novo
                const newProduct = {
                    id: Date.now(),
                    name, 
                    description: desc,
                    price,
                    category: cat,
                    image: image || "https://placehold.co/400x300/1a1a1a/red?text=Sem+Imagem",
                    rating: 5.0, time: "N/A", calories: "N/A", sales: 0, 
                    tags: tags, 
                    options: [],
                    active: true // Default to active
                };
                state.menu.push(newProduct);
            }

            resetForm();
            renderAdminList();
            renderMenu();
            renderBestSellers();
            alert("Cardápio atualizado com sucesso!");
        }

        // --- Tema ---
        function initTheme() {
            if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
                updateThemeIcon(true);
            } else {
                document.documentElement.classList.remove('dark');
                updateThemeIcon(false);
            }
        }
        function toggleTheme() {
            if (document.documentElement.classList.contains('dark')) {
                document.documentElement.classList.remove('dark');
                localStorage.theme = 'light';
                updateThemeIcon(false);
            } else {
                document.documentElement.classList.add('dark');
                localStorage.theme = 'dark';
                updateThemeIcon(true);
            }
        }
        function updateThemeIcon(isDark) {
            const icon = document.getElementById('theme-icon');
            icon.setAttribute('data-lucide', isDark ? 'sun' : 'moon');
            lucide.createIcons();
        }
    </script>
</body>
</html>